{% extends 'base.html' %}
{% block title %}Ticket Details{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row">
        <div class="col-md-8">
            <h3>{{ ticket.titre }}</h3>
            <p>{{ ticket.description_ticket }}</p>
            <p>Category: {{ ticket.category.category_name }}</p>
            <p>Urgency: {{ ticket.urgent }}</p>
        </div>
    </div>
    {% if current_user.role.name == 'admin' and ticket.statut != 'clos' %}
    <div class="row mt-3">
        <div class="col-md-12">
            <form method="post">
                {{ close_form.hidden_tag() }}
                {{ close_form.close(class="btn btn-danger") }}
            </form>
        </div>
    </div>
    {% if ticket.category.category_name == 'Panne Hard' or ticket.material_id %}
    <div class="row mt-3">
        <div class="col-md-12">
            <a href="{{ url_for('admin.repair_ticket', ticket_id=ticket.id_ticket) }}" class="btn btn-warning">Send to Repair</a>
        </div>
    </div>
    {% endif %}
    {% endif %}
    {% if current_user.role.name != 'super_admin' and ticket.statut != 'clos' %}
    <div class="row mt-3">
        <div class="col-md-12">
            <div class="comments">
                {% for comment in comments %}
                <div class="comment d-flex align-items-start mb-3 {{ 'current-user' if comment.user_id == current_user.user_id else 'other-user' }}">
                    {% if comment.user_id == current_user.user_id %}
                    <div class="avatar me-3">
                        {% if current_user.role.name == 'admin' %}
                        <img src="{{ url_for('static', filename='img/admin.png') }}" alt="Admin Avatar" class="rounded-circle" width="50">
                        {% elif current_user.role.name == 'employee' %}
                        <img src="{{ url_for('static', filename='img/avatar.png') }}" alt="Employee Avatar" class="rounded-circle" width="50">
                        {% endif %}
                    </div>
                    {% endif %}
                    <div class="comment-body">
                        <p>{{ comment.comment_text }}</p>
                        <p class="small text-muted">By: {{ comment.user.username }} on {{ comment.created_at }}</p>
                    </div>
                    {% if comment.user_id != current_user.user_id %}
                    <div class="avatar ms-3">
                        {% if comment.user.role.name == 'admin' %}
                        <img src="{{ url_for('static', filename='img/admin.png') }}" alt="Admin Avatar" class="rounded-circle" width="50">
                        {% elif comment.user.role.name == 'employee' %}
                        <img src="{{ url_for('static', filename='img/avatar.png') }}" alt="Employee Avatar" class="rounded-circle" width="50">
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    <div class="row mt-3">
        <div class="col-md-12">
            <h3>Add a Comment</h3>
            <form method="post">
                {{ comment_form.hidden_tag() }}
                <div class="form-group">
                    {{ comment_form.comment_text.label(class="form-label") }}
                    {{ comment_form.comment_text(class="form-control") }}
                </div>
                <div class="form-group mt-3">
                    {{ comment_form.submit(class="btn btn-primary") }}
                </div>
            </form>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}
