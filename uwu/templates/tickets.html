{% extends 'base.html' %}

{% block content %}
<div class="container mt-5">
    <h2>Tickets - {{ status }}</h2>
    <table class="table table-hover">
        <thead>
            <tr>
                <th>Title</th>
                <th>Category</th>
                <th>Urgency</th>
                <th>Material</th>
                {% if current_user.role.name in ['admin', 'super_admin'] %}
                <th>Creator</th>
                {% if status != 'nouveau' %}
                <th>Assigned Admin</th>
                {% endif %}
                {% if status == 'en_reparation' %}
                <th>Fournisseur</th>
                <th>Days in Repair</th>
                {% elif status == 'clos' %}
                <th>Was in Repair</th>
                {% endif %}
                {% endif %}
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for ticket in tickets_list %}
            <tr>
                <td>{{ ticket.titre }}</td>
                <td>{{ ticket.category_name }}</td>
                <td>{{ ticket.urgent }}</td>
                <td>{{ ticket.material_name or 'N/A' }}</td>
                {% if current_user.role.name in ['admin', 'super_admin'] %}
                <td>{{ ticket.creator_username }}</td>
                {% if status != 'nouveau' %}
                <td>{{ ticket.assigned_admin_username or 'N/A' }}</td>
                {% endif %}
                {% if status == 'en_reparation' %}
                <td>{{ ticket.fournisseur_name or 'N/A' }}</td>
                <td>{{ (current_date - ticket.date_parti_reparation).days if ticket.date_parti_reparation else 'N/A' }}</td>
                {% elif status == 'clos' %}
                <td>{{ 'Yes' if ticket.was_in_repair else 'No' }}</td>
                {% endif %}
                {% endif %}
                <td>
                    {% if current_user.role.name == 'super_admin' %}
                    <a href="{{ url_for('admin.view_ticket', ticket_id=ticket.id_ticket) }}" class="btn btn-action" title="View Ticket">
                        <span class="material-symbols-outlined bt">visibility</span>
                    </a>
                    {% elif ticket.statut != 'nouveau' and (current_user.role.name == 'admin' or current_user.role.name == 'employee') %}
                    <a href="{{ url_for('admin.view_ticket', ticket_id=ticket.id_ticket) }}" class="btn btn-action" title="View Ticket">
                        <span class="material-symbols-outlined bt">visibility</span>
                    </a>
                    {% endif %}
                    {% if (ticket.statut == 'nouveau' or ticket.statut == 'en_cours') and current_user.role.name == 'super_admin' %}
                    <a href="{{ url_for('super_admin.assign_ticket', ticket_id=ticket.id_ticket) }}" class="btn btn-action" title="Affecter">
                        <span class="material-symbols-outlined bt">assignment_add</span>
                    </a>
                    {% elif ticket.statut == 'nouveau' and current_user.role.name == 'employee' %}
                    <a href="{{ url_for('employee.edit_ticket', ticket_id=ticket.id_ticket) }}" class="btn btn-action" title="Edit">
                        <span class="material-symbols-outlined bt">edit</span>
                    </a>
                    {% endif %}
                    {% if current_user.role.name == 'admin' %}
                    <a href="{{ url_for(current_user.role.name +'.edit_ticket', ticket_id=ticket.id_ticket) }}" class="btn btn-action" title="Edit">
                        <span class="material-symbols-outlined bt">edit</span>
                    </a>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}
